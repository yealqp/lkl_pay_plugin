# å®‰å…¨é…ç½®è¯´æ˜

## ğŸš¨ é‡è¦ï¼šå¿…é¡»å®Œæˆä»¥ä¸‹å®‰å…¨é…ç½®æ‰èƒ½æŠ•å…¥ç”Ÿäº§ä½¿ç”¨ï¼

### 1. é…ç½® API å¯†é’¥ï¼ˆPython ç«¯ï¼‰

ç¼–è¾‘ `python_api/config.json`ï¼š

```json
{
    "API_SECRET_KEY": "ç”Ÿæˆä¸€ä¸ªå¼ºéšæœºå­—ç¬¦ä¸²ï¼Œè‡³å°‘32ä½",
    "CALLBACK_SECRET": "ç”Ÿæˆå¦ä¸€ä¸ªå¼ºéšæœºå­—ç¬¦ä¸²ï¼Œè‡³å°‘32ä½",
    "ALLOWED_CALLBACK_DOMAINS": ["ä½ çš„åŸŸå.com", "www.ä½ çš„åŸŸå.com"]
}
```

**ç”Ÿæˆå¼ºå¯†é’¥çš„æ–¹æ³•ï¼ˆPythonï¼‰ï¼š**
```python
import secrets
print("API_SECRET_KEY:", secrets.token_urlsafe(32))
print("CALLBACK_SECRET:", secrets.token_urlsafe(32))
```

### 2. é…ç½® API å¯†é’¥ï¼ˆPHP ç«¯ï¼‰

åœ¨ PHP åå°è¿›å…¥ã€Œæ’ä»¶ç®¡ç†ã€->ã€Œæ‹‰å¡æ‹‰æ”¶é“¶å°ã€->ã€Œé…ç½®ã€ï¼š

1. **APIå¯†é’¥**ï¼šå¡«å†™ä¸ Python çš„ `API_SECRET_KEY` ç›¸åŒçš„å€¼
2. **å›è°ƒç­¾åå¯†é’¥**ï¼šå¡«å†™ä¸ Python çš„ `CALLBACK_SECRET` ç›¸åŒçš„å€¼

**é‡è¦ï¼š** ä¸¤ä¸ªå¯†é’¥å¿…é¡»ä¸ Python é…ç½®å®Œå…¨ä¸€è‡´ï¼

### 3. ~~é…ç½®å›è°ƒç­¾åå¯†é’¥ï¼ˆPHP ç«¯ï¼‰~~

**å·²è‡ªåŠ¨åŒ–ï¼š** å¯†é’¥ç°åœ¨ä»åå°é…ç½®è¯»å–ï¼Œæ— éœ€æ‰‹åŠ¨ä¿®æ”¹ä»£ç ï¼

### 4. å®‰å…¨æ£€æŸ¥æ¸…å•

- [ ] å·²ç”Ÿæˆå¹¶é…ç½®å¼ºéšæœºçš„ `API_SECRET_KEY`ï¼ˆè‡³å°‘32ä½ï¼‰
- [ ] å·²ç”Ÿæˆå¹¶é…ç½®å¼ºéšæœºçš„ `CALLBACK_SECRET`ï¼ˆè‡³å°‘32ä½ï¼‰
- [ ] Python å’Œ PHP åå°çš„å¯†é’¥é…ç½®ä¸€è‡´
- [ ] å·²é…ç½® `ALLOWED_CALLBACK_DOMAINS` ç™½åå•
- [ ] æ—¥å¿—æ–‡ä»¶æƒé™å·²è®¾ç½®ï¼ˆä»…æ‰€æœ‰è€…å¯è¯»å†™ï¼‰
- [ ] Python API ä»…ç›‘å¬å†…ç½‘åœ°å€æˆ–ä½¿ç”¨åå‘ä»£ç†
- [ ] å¯ç”¨ HTTPSï¼ˆç”Ÿäº§ç¯å¢ƒå¿…éœ€ï¼‰

## å®‰å…¨åŠ å›ºè¯¦æƒ…

### âœ… å·²å®ç°çš„å®‰å…¨æªæ–½

1. **API è®¤è¯**
   - Python API æ”¯æŒ `X-API-Key` å¤´éƒ¨éªŒè¯
   - æœªæˆæƒè¯·æ±‚è¿”å› 401 é”™è¯¯

2. **å›è°ƒç­¾åéªŒè¯**
   - Python å›è°ƒ PHP æ—¶æºå¸¦ MD5 ç­¾å
   - PHP éªŒè¯ç­¾åï¼Œé˜²æ­¢ä¼ªé€ å›è°ƒåˆ·é’±

3. **é˜²é‡æ”¾æ”»å‡»**
   - Python ç«¯ç¼“å­˜å·²å¤„ç†è®¢å•å·
   - PHP ç«¯è®°å½•å·²å¤„ç†è®¢å•å·
   - é‡å¤å›è°ƒè‡ªåŠ¨æ‹’ç»

4. **å›è°ƒåœ°å€ç™½åå•**
   - é…ç½® `ALLOWED_CALLBACK_DOMAINS` é™åˆ¶å›è°ƒåŸŸå
   - é˜²æ­¢æ”»å‡»è€…æŒ‡å®šä»»æ„å›è°ƒåœ°å€

5. **æ•æ„Ÿä¿¡æ¯ä¿æŠ¤**
   - æ—¥å¿—ä¸­ä¸è®°å½•å®Œæ•´çš„æ•æ„Ÿæ•°æ®
   - åªè®°å½•å¿…è¦çš„ä¸šåŠ¡ä¿¡æ¯

### âš ï¸ éœ€è¦è¿›ä¸€æ­¥åŠ å›ºçš„åœ°æ–¹

1. **æ•°æ®åº“æŒä¹…åŒ–**
   - å½“å‰å·²å¤„ç†è®¢å•å·å­˜å‚¨åœ¨å†…å­˜/æ–‡ä»¶ä¸­
   - å»ºè®®æ”¹ä¸º Redis æˆ–æ•°æ®åº“å­˜å‚¨

2. **HTTPS å¼ºåˆ¶**
   - ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ HTTPS
   - é˜²æ­¢ä¸­é—´äººæ”»å‡»

3. **é€Ÿç‡é™åˆ¶**
   - å»ºè®®æ·»åŠ  API è°ƒç”¨é¢‘ç‡é™åˆ¶
   - é˜²æ­¢æ¶æ„åˆ·å•

4. **IP ç™½åå•**
   - å¯ä»¥é…ç½®åªå…è®¸ç‰¹å®š IP è®¿é—® Python API

## ç­¾åç®—æ³•è¯´æ˜

### Python ç”Ÿæˆç­¾å
```python
data = {
    "invoice_id": "123",
    "payOrderNo": "456",
    "tradeAmount": "0.01",
    "currency": "CNY"
}
# æŒ‰keyæ’åº
sorted_items = sorted(data.items())
# æ‹¼æ¥ï¼šinvoice_id=123&payOrderNo=456&tradeAmount=0.01&currency=CNY&key=å¯†é’¥
sign_str = "&".join([f"{k}={v}" for k, v in sorted_items]) + "&key=å¯†é’¥"
# MD5 å¤§å†™
signature = hashlib.md5(sign_str.encode('utf-8')).hexdigest().upper()
```

### PHP éªŒè¯ç­¾å
```php
ksort($data);
$signStr = '';
foreach ($data as $key => $value) {
    $signStr .= $key . '=' . $value . '&';
}
$signStr .= 'key=' . $secret;
$expectedSign = strtoupper(md5($signStr));
```

## æµ‹è¯•ç­¾åéªŒè¯

### æµ‹è¯•æ•°æ®
```json
{
    "invoice_id": "800001",
    "payOrderNo": "25111511012001101011529076866",
    "tradeAmount": "0.01",
    "currency": "CNY"
}
```

### ä½¿ç”¨å¯†é’¥ï¼š`test_secret_123`

**æ­£ç¡®çš„ç­¾åï¼š**
```
currency=CNY&invoice_id=800001&payOrderNo=25111511012001101011529076866&tradeAmount=0.01&key=test_secret_123
MD5: 7A9C8B6E5D4F3A2B1C0D9E8F7A6B5C4D (ç¤ºä¾‹)
```

## ç´§æ€¥æƒ…å†µå¤„ç†

### å¦‚æœæ€€ç–‘å¯†é’¥æ³„éœ²

1. **ç«‹å³æ›´æ¢å¯†é’¥**
   ```bash
   # ç”Ÿæˆæ–°å¯†é’¥
   python -c "import secrets; print(secrets.token_urlsafe(32))"
   ```

2. **æ›´æ–° Python é…ç½®**
   ```json
   {
       "API_SECRET_KEY": "æ–°å¯†é’¥1",
       "CALLBACK_SECRET": "æ–°å¯†é’¥2"
   }
   ```

3. **æ›´æ–° PHP é…ç½®**
   - åå°æ’ä»¶é…ç½®æ›´æ–° `api_secret_key`
   - ä»£ç ä¸­æ›´æ–° `$secret`

4. **é‡å¯æœåŠ¡**
   ```bash
   # é‡å¯ Python API
   ```

5. **æ£€æŸ¥æ—¥å¿—**
   - æŸ¥æ‰¾å¼‚å¸¸çš„è®¢å•åˆ›å»ºæˆ–å›è°ƒè®°å½•
   - æ£€æŸ¥æ˜¯å¦æœ‰æœªæˆæƒè®¿é—®

## è”ç³»ä¸æ”¯æŒ

å¦‚å‘ç°å®‰å…¨é—®é¢˜ï¼Œè¯·ç«‹å³è”ç³»æŠ€æœ¯å›¢é˜Ÿã€‚
